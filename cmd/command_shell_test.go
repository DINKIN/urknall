package cmd

import (
	"github.com/dynport/zwo/host"
	. "github.com/smartystreets/goconvey/convey"
	"testing"
)

func TestCommandActionDocker(t *testing.T) {
	Convey("Given a command", t, func() {
		rawCmd := "do something"
		Convey("When the command is converted for docker", func() {
			h, _ := host.New("127.0.0.1", "", "")
			c := &ShellCommand{Command: rawCmd}
			v := c.Docker(h)
			Convey("The value should be a valid dockerfile line", func() {
				So(v, ShouldEqual, "RUN do something")
			})
		})
	})
}

func TestCommandActionLogging(t *testing.T) {
	Convey("Given a command", t, func() {
		rawCmd := "do something"
		Convey("When the command is converted for logging", func() {
			h, _ := host.New("127.0.0.1", "", "")
			c := &ShellCommand{Command: rawCmd}
			Convey("When the command has no further settings", func() {
				Convey("The line should have the COMMAND hint and contain the command", func() {
					v := c.Logging(h)
					So(v, ShouldEqual, "[COMMAND] # do something")
				})
			})

			Convey("When the host user is set to something other then 'root'", func() {
				h, _ = host.New("127.0.0.1", "gfrey", "")
				Convey("Then the SUDO hint should be added to the logging line", func() {
					v := c.Logging(h)
					So(v, ShouldContainSubstring, "[SUDO]")
				})
			})

			Convey("When the command user is set", func() {
				c.user = "gfrey"
				Convey("Then the SU hint should be added to the logging line with the correct user", func() {
					v := c.Logging(h)
					So(v, ShouldContainSubstring, "[SU:gfrey]")
				})
			})
		})
	})
}

func TestCommandActionShell(t *testing.T) {
	Convey("Given a command", t, func() {
		rawCmd := "do something"
		Convey("When the command is converted for shell", func() {
			c := &ShellCommand{Command: rawCmd}
			Convey("Then without further settings the value should be equal to the source", func() {
				h, _ := host.New("127.0.0.1", "", "")
				v := c.Shell(h)
				So(v, ShouldEqual, rawCmd)
			})

			Convey("When the command should be run as root (aka no user given)", func() {
				Convey("When the user for the host is not given", func() {
					h, _ := host.New("127.0.0.1", "", "")
					v := c.Shell(h)
					Convey("The value should be a valid simple bash command", func() {
						So(v, ShouldEqual, rawCmd)
					})
				})

				Convey("When the user for the host is explicitly set to 'root'", func() {
					h, _ := host.New("127.0.0.1", "root", "")
					v := c.Shell(h)
					Convey("The value should be valid simple bash command", func() {
						So(v, ShouldEqual, rawCmd)
					})
				})

				Convey("When the user for the host is set to something different then 'root'", func() {
					h, _ := host.New("127.0.0.1", "gfrey", "")
					v := c.Shell(h)
					Convey("The value should be valid sudo command", func() {
						So(v, ShouldStartWith, "sudo bash <<EOF")
						So(v, ShouldContainSubstring, rawCmd)
					})
				})
			})

			Convey("When command should be run as a different user", func() {
				c.user = "gfrey"

				Convey("When the user for the host is not given", func() {
					h, _ := host.New("127.0.0.1", "", "")
					v := c.Shell(h)
					Convey("The value should be a valid bash command run as user 'gfrey'", func() {
						So(v, ShouldStartWith, "su -l gfrey <<EOF\n")
						So(v, ShouldContainSubstring, rawCmd)
					})
				})

				Convey("When the user for the host is explicitly set to 'root'", func() {
					h, _ := host.New("127.0.0.1", "root", "")
					v := c.Shell(h)
					Convey("The value should be a valid bash command run as user 'gfrey'", func() {
						So(v, ShouldStartWith, "su -l gfrey <<EOF\n")
						So(v, ShouldContainSubstring, rawCmd)
					})
				})

				Convey("When the user for the host is set to something different then 'root'", func() {
					h, _ := host.New("127.0.0.1", "gfrey", "")
					v := c.Shell(h)
					Convey("The value should be a valid bash command run with sudo and as user 'gfrey'", func() {
						So(v, ShouldStartWith, "sudo -- su -l gfrey <<EOF")
						So(v, ShouldContainSubstring, rawCmd)
					})
				})
			})
		})
	})
}
